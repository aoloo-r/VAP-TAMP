# Segway Robot Configuration for Stretch AI - OPTIMIZED FOR PATH PLANNING
# This configuration fixes obstacle detection issues for better navigation

# Base configuration
vlm_base_config: default_planner.yaml

# ROS2 topic mapping for rosbridge setup
ros2:
  # Camera topics
  rgb_topic: "/camera/color/image_raw"
  depth_topic: "/camera/depth/image_rect_raw"
  camera_info_topic: "/camera/color/camera_info"

  # Robot state topics
  joint_state_topic: "/joint_states"
  odom_topic: "/odom"
  odom_fallback_topic: "/odom"

  # Control topics (Segway-specific)
  cmd_vel_topic: "/segway/cmd_vel"

  # Navigation topics
  goal_topic: "/move_base_simple/goal"
  status_topic: "/move_base/status"

  # LIDAR topic
  lidar_topic: "/scan"

# Segway robot physical parameters
segway_robot:
  width: 0.25      # 25cm width
  length: 0.30     # 30cm length
  height: 0.10     # 10cm base height
  max_speed: 1.0   # 1 m/s max speed
  max_angular_speed: 1.0  # 1 rad/s max angular speed

# OPTIMIZED obstacle detection for better path planning
collision_detection:
  allow_partial_exploration: true
  obstacle_padding_reduction: 0.3  # Reduce obstacle padding for navigation

# Camera transform for Segway (adjust based on your setup)
camera_transform: [
  0.0,  0.0,  1.0,  0.3,   # Camera forward = Robot X, 30cm forward
  -1.0, 0.0,  0.0,  0.0,   # Camera right = Robot -Y
  0.0, -1.0,  0.0,  0.6,   # Camera down = Robot -Z, 60cm height
  0.0,  0.0,  0.0,  1.0    # Homogeneous coordinates
]

# CORE FIX: Optimized voxel mapping for path planning
encoder: "dinov2siglip"
encoder_args: { "version": "google/siglip-base-patch16-224" }
voxel_size: 0.04

# CRITICAL: Obstacle detection parameters - OPTIMIZED
obs_min_height: 0.10     # 10cm above ground (avoid floor noise)
obs_max_height: 1.8      # 1.8m max height (exclude ceiling, focus on navigation obstacles)
neg_obs_height: -0.03    # 3cm below ground for floor detection
use_negative_obstacles: false  # Disable to reduce floor-level obstacles

# CRITICAL: Density thresholds - MUCH MORE PERMISSIVE
obs_min_density: 1       # Very lenient obstacle detection (was 3)
min_points_per_voxel: 1  # Accept sparse point clouds (was 3)

# CRITICAL: Obstacle padding - REDUCED
pad_obstacles: 0         # No obstacle padding for path planning (was 1)
min_pad_obstacles: 0     # No minimum padding

# Additional optimizations
local_radius: 0.8
add_local_every_step: false
remove_visited_from_obstacles: true  # Remove robot's path from obstacles
min_depth: 0.1
max_depth: 5.0

# CRITICAL: Disable aggressive smoothing that creates false obstacles
filters:
  smooth_kernel_size: 0     # Disable morphological smoothing
  use_median_filter: false
  use_derivative_filter: false

# VLM configuration
vlm:
  vlm_option: gemini
  vlm_context_length: 100
  save_vlm_plan: true
  replanning: false
  sample_strategy: "clip"

# OPTIMIZED Navigation parameters for Segway
motion_planner:
  step_size: 0.03          # Smaller steps for more precise planning
  rotation_step_size: 0.08  # Smaller rotation steps
  algorithm: "rrt_connect"
  max_iter: 5000           # MORE iterations for complex environments (was 3000)
  is_safe_threshold: -2.0  # VERY permissive collision detection (was -1.0)
  simplify_plans: true
  shortcut_plans: true
  use_hybrid_navigation: false  # Pure 3D voxel navigation + camera obstacle avoidance
  simplify:
    max_step: 0.4
    min_step: 0.03
    num_steps: 10
    min_angle: 0.05
  shortcut_iter: 150
  frontier:
    dilate_frontier_size: 1
    dilate_obstacle_size: 1  # REDUCED obstacle dilation (was 2)
    default_expand_frontier_size: 8
    min_dist: 0.08
    step_dist: 0.15
  goals:
    manipulation_radius: 1.2   # Larger radius for navigation approach (was 1.0)

# Navigation with visual servoing
navigation:
  use_visual_servoing: true

# OPTIMIZED Robot footprint for collision detection
robot_footprint:
  width: 0.20      # REDUCED width for easier navigation (was 0.25)
  length: 0.25     # REDUCED length (was 0.30)
  width_offset: 0.0
  length_offset: 0.0

# Execution parameters optimized for Segway
trajectory_pos_err_threshold: 0.20   # More tolerant position error (was 0.15)
trajectory_rot_err_threshold: 0.5    # More tolerant rotation error (was 0.4)
trajectory_per_step_timeout: 6.0     # Longer timeout per step (was 4.0)

# Scene graph for spatial relationships
guarantee_instance_is_reachable: true
plan_with_reachable_instances: true
plan_with_scene_graph: true
scene_graph:
  max_near_distance: 0.25  # Smaller distances for Segway
  min_on_height: 0.03
  max_on_height: 0.15

# Task configuration
task:
  command: ""  # Empty for interactive mode

# Robot type specification
robot_type: "segway"